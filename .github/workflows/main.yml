# This workflow will build a package using Maven and then deploy it to Google Appengine when something 
# is pushed to the master branch.

name: Maven Package

on:
  push:
    branches: [master]

env:
  PROJECT_ID: ${{secrets.GCP_PROJECT_ID}}

jobs:
  build:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2
    - name: Set up JDK 1.8
      uses: actions/setup-java@v1
      with:
        java-version: 1.8
        server-id: github # Value of the distributionManagement/repository/id field of the pom.xml
        settings-path: ${{ github.workspace }} # location for the settings.xml file

    - name: Maven clean install
      run: mvn clean install

    # Setup gcloud authentication
    - uses: GoogleCloudPlatform/github-actions/setup-gcloud@master
      with:
        version: '290.0.1'
        project_id: $PROJECT_ID
        service_account_key: ${{ secrets.GCP_SA_KEY }}
        export_default_credentials: true
        
    - name: Authenticate
      run: gcloud info
    
    - name: Maven Appengine Deploy
      run: mvn package appengine:deploy
